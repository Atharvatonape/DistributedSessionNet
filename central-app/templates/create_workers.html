<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create and Manage Workers</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}"">
    <link rel="icon" href="{{ url_for('static', filename='fav.jpg') }}" type="image/png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);

            socket.on('update', function(data) {
                document.getElementById("statusMessage").textContent = data.message;
                if (data.message.includes('created') || data.message.includes('killed')) {
                    loadWorkers();
                }
            });

            document.getElementById('startButton').onclick = function() {
                var numWorkers = document.getElementById('numWorkersSelect').value;
                socket.emit('start_create_workers', {num_workers: parseInt(numWorkers, 10)});
            };

            document.getElementById('killButton').onclick = function() {
                var selectedWorker = document.getElementById('workerSelect').value;
                if (selectedWorker === "Select All") {
                    socket.emit('kill_all_workers');
                } else {
                    socket.emit('kill_worker', {worker_name: selectedWorker});
                }
            };

            document.getElementById('refreshButton').onclick = function() {
                loadWorkers();
            };

            document.getElementById('getStatusButton').onclick = function() {
                fetchWorkerStatus();
            };

            document.getElementById('sendFakeDataButton').onclick = function() {

                // Request the backend to generate fake data and send it to the worker
                $.post('/send_fake_data', function(response) {
                    console.log('Response from server:', response);
                    document.getElementById("statusMessage").textContent = "Fake data sent to " + response.worker;
                    setTimeout(fetchWorkerStatus, 1200);
                    //setTimeout(fetchWorkerStatus, 3000);
                }).fail(function(xhr, status, error) {
                    alert("Failed to send fake data." + xhr.responseText);
                });
            };




            function loadWorkers() {
                $.getJSON('/workers_get', function(workers) {
                    var select = document.getElementById('workerSelect');
                    var workerList = document.getElementById('activeWorkers');
                    select.innerHTML = '<option>Select All</option>';
                    workerList.innerHTML = '<h3>Active Workers</h3><ul>';

                    workers.forEach(function(worker) {
                        var option = new Option(worker, worker);
                        select.add(option);
                        workerList.innerHTML += `<li>${worker}</li>`;
                    });

                    workerList.innerHTML += '</ul>';
                });
            }

            function fetchWorkerStatus() {
                for (let i = 1; i <= 5; i++) {
                    document.getElementById(`workerStatus${i}`).innerHTML = 'Loading...';
                }

                $.getJSON('/workers', function(workers) {
                    let allPromises = [];  // Array to hold all fetch promises

                    for (let i = 1; i <= 5; i++) {
                        if (i <= workers.length) {
                            let url = workers[i - 1];
                            let fetchPromise = $.get(url + '/status', function(status) {
                                let requestsHandled = status.requests_handled || 0;
                                let totalRequests = 2;

                                let content = `<div class='worker-info'>
                                                <p><strong>Name:</strong> ${status.name}</p>
                                                <p><strong>Active:</strong> ${status.active ? 'Yes' : 'No'}</p>
                                                <p><strong>Requests Handled:</strong> ${requestsHandled} / ${totalRequests}</p>
                                                <p><strong>Last Request:</strong> ${status.latest_request}</p>
                                            </div>`;
                                document.getElementById(`workerStatus${i}`).innerHTML = content;
                                if (requestsHandled >= totalRequests) {
                                    document.getElementById(`workerStatus${i}`).innerHTML += '<p style="color: red;">Worker has reached the request limit.</p>';
                                }

                                return { worker_id: status.name, state: status.active };
                            }).fail(function() {
                                document.getElementById(`workerStatus${i}`).innerHTML = 'Failed to load data';
                            });

                            allPromises.push(fetchPromise);
                        } else {
                            document.getElementById(`workerStatus${i}`).innerHTML = 'No active worker';
                        }
                    }

                    // When all promises are resolved, send updates to the TaskManager
                    Promise.all(allPromises).then(results => {
                        results.forEach(result => {
                            if (result) {
                                $.ajax({
                                    url: '/update_status',
                                    type: 'POST',
                                    contentType: 'application/json',
                                    data: JSON.stringify(result),
                                    success: function(response) {
                                        console.log('Task Manager Update Response:', response);
                                    },
                                    error: function(xhr, status, error) {
                                        console.log('Error updating Task Manager:', xhr.responseText);
                                    }
                                });
                            }
                        });
                    });
                });
            }
        });
    </script>
</head>
<body>
    <h1>Worker Creation and Management</h1>
    <select id="numWorkersSelect">
        <option value="1">1 Worker</option>
        <option value="2">2 Workers</option>
        <option value="3">3 Workers</option>
        <option value="4">4 Workers</option>
        <option value="5">5 Workers</option>
    </select>
    <button id="startButton">Create Workers</button>
    <button id="refreshButton">Refresh Active Containers</button>
    <button id="getStatusButton">Get Worker Status</button>
    <button id="sendFakeDataButton">Send Fake Data to Node</button>
    <button id="killButton">Kill Selected Worker</button>
    <select id="workerSelect"><option>Select All</option></select>
    <p id="statusMessage">Ready to create or kill workers.</p>
    <div id="activeWorkers"></div>
    <div class="worker-status-container">
        <div id="workerStatus1" class="worker-status">No active worker</div>
        <div id="workerStatus2" class="worker-status">No active worker</div>
        <div id="workerStatus3" class="worker-status">No active worker</div>
        <div id="workerStatus4" class="worker-status">No active worker</div>
        <div id="workerStatus5" class="worker-status">No active worker</div>
    </div>
</body>
</html>