<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create and Manage Workers</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // Poll the backend every 5 seconds to fetch the latest worker status
            // setInterval(function() {
            //     fetchWorkerStatus();
            // }, 5000);

            document.getElementById('startButton').onclick = function() {
                event.preventDefault();
                var numWorkers = document.getElementById('numWorkersSelect').value;
                $.ajax({
                    url: '/create_workers',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({num_workers: parseInt(numWorkers, 10)}),
                    success: function(response) {
                        document.getElementById("statusMessage").textContent = response.message;
                        loadWorkers(); // Refresh worker list after creation
                    },
                    error: function(xhr, status, error) {
                        alert("Error creating workers: " + xhr.responseText);
                    }
                });
            };

            document.getElementById('idleButton').onclick = function() {
                event.preventDefault();
                var idle_time = document.getElementById('idle_time_select').value;
                $.ajax({
                    url: '/idle_time',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({idletime: parseInt(idle_time, 10)}),
                    success: function(response) {
                        document.getElementById("statusMessage").textContent = response.message;
                        loadWorkers(); // Refresh worker list after creation
                    },
                    error: function(xhr, status, error) {
                        alert("Error creating workers: " + xhr.responseText);
                    }
                });
            };

            document.getElementById('killButton').onclick = function() {
                event.preventDefault();
                var selectedWorker = document.getElementById('workerSelect').value;
                if (selectedWorker === "Select All") {
                    $.post('/kill_all_workers', function(response) {
                        document.getElementById("statusMessage").textContent = response.message;
                        loadWorkers(); // Refresh worker list after killing
                    }).fail(function(xhr, status, error) {
                        alert("Error killing all workers: " + xhr.responseText);
                    });
                } else {
                    $.ajax({
                        url: '/kill_worker',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({worker_name: selectedWorker}),
                        success: function(response) {
                            document.getElementById("statusMessage").textContent = response.message;
                            loadWorkers(); // Refresh worker list after killing
                        },
                        error: function(xhr, status, error) {
                            alert("Error killing worker: " + xhr.responseText);
                        }
                    });
                }
            };

            document.getElementById('refreshButton').addEventListener('click', function() {
                fetchWorkerStatus();
                loadWorkers();
                fetchDetailedWorkerStatuses(); // Trigger getStatusButton functionality
            });


            // document.getElementById('getStatusButton').onclick = function() {
            //     event.preventDefault();
            //     fetchWorkerStatus(); // Manually get worker status
            //     loadWorkers(); // Manually get worker list
            //     fetchDetailedWorkerStatuses(); // Manually get detailed status
            // };

            document.getElementById('sendFakeDataButton').onclick = function() {
                event.preventDefault();
                $.post('/send_fake_data', function(response) {
                    document.getElementById("statusMessage").textContent = "Fake data sent successfully!";
                }).fail(function(xhr, status, error) {
                    alert("Failed to send fake data: " + xhr.responseText);
                });
            };

            // Fetch worker status from the backend
        function loadWorkers() {
            console.log('Fetching worker data... loadWorkers()');
            $.getJSON('/workers_get', function(data) {
                console.log('Data received:', data);  // Check what data is received

                // Update metrics
                document.getElementById('activeWorkers').textContent = data.activeWorkers;
                document.getElementById('successfulTasks').textContent = data.successfulTasks;
                document.getElementById('taskListDuplicates').textContent = data.taskListDuplicateCount;

                var workerList = document.getElementById('activeWorkersList');
                workerList.innerHTML = `<h3>Active Workers: ${data.activeWorkers}</h3>`;

                // Clear existing options in the worker select dropdown for killing workers
                var killWorkerSelect = document.getElementById('workerSelect');
                killWorkerSelect.innerHTML = '';  // Clear existing options

                // Check if there are workers and add options accordingly
                if (data.workers && data.workers.length > 0) {
                    if (data.workers.length > 1) {
                        killWorkerSelect.add(new Option("Select All", "Select All"));
                    }

                    // Add new active workers to the kill dropdown
                    data.workers.forEach(function(worker) {
                        var option = new Option(worker, worker);
                        killWorkerSelect.add(option);
                        workerList.innerHTML += `<li>${worker}</li>`;  // Also update the worker list display
                    });
                } else {
                    console.log('No workers found');
                }
            }).fail(function(jqxhr, textStatus, error) {
                var err = textStatus + ", " + error;
                console.log("Request Failed: " + err);
            });
        }

            function fetchWorkerStatus() {
                console.log('Fetching worker status... fetchWorkerStatus()');
                for (let i = 1; i <= 5; i++) {
                    document.getElementById(`workerStatus${i}`).innerHTML = 'Not Active';
                }

                $.getJSON('/workers', function(workers) {
                    let allPromises = [];

                    workers.forEach(function(workerName, index) {
                        let url = `/worker_status/${workerName}`;
                        console.log(`Fetching status from: ${url}`);

                        let fetchPromise = $.get(url, function(status) {
                            let requestsHandled = status.requests_handled || 0;
                            let totalRequests = 5;

                            let content = `<div class='worker-info'>
                                                <p><strong>Name:</strong> ${status.name}</p>
                                                <p><strong>Active:</strong> ${status.active ? 'Yes' : 'No'}</p>
                                                <p><strong>Requests Handled:</strong> ${requestsHandled} / ${totalRequests}</p>
                                                <p><strong>Last Request:</strong> ${status.latest_request}</p>
                                            </div>`;
                            document.getElementById(`workerStatus${index + 1}`).innerHTML = content;
                            if (requestsHandled >= totalRequests) {
                                document.getElementById(`workerStatus${index + 1}`).innerHTML += '<p style="color: red;">Worker has reached the request limit.</p>';
                            }

                            return { worker_id: status.name, state: status.active };
                        }).fail(function() {
                            document.getElementById(`workerStatus${index + 1}`).innerHTML = 'Failed to load data';
                        });

                        //allPromises.push(fetchPromise);
                    });

                    Promise.all(allPromises).then(results => {
                        results.forEach(result => {
                            if (result) {
                                $.ajax({
                                    url: '/update_status',
                                    type: 'POST',
                                    contentType: 'application/json',
                                    data: JSON.stringify(result),
                                    success: function(response) {
                                        console.log('Task Manager Update Response:', response);
                                    },
                                    error: function(xhr, status, error) {
                                        console.log('Error updating Task Manager:', xhr.responseText);
                                    }
                                });
                            }
                        });
                    });
                });
            }

            function fetchDetailedWorkerStatuses() {
                console.log('Fetching detailed worker statuses... fetchDetailedWorkerStatuses()');
                $('#detailedWorkerStatusContainer').html('<p>Loading detailed statuses...</p>');

                // Define the list of all workers
                const workers = ['worker_1', 'worker_2', 'worker_3', 'worker_4', 'worker_5'];

                let content = '<h2>Detailed Worker Statuses</h2>';

                // Iterate through the predefined list of workers
                workers.forEach(function(workerName) {
                    let url = `/worker_status2/${workerName}`;

                    $.get(url, function(status) {
                        let tableContent = `<div class='worker-details'>
                                            <h3>Status for ${workerName} - Active: ${status.active ? 'Yes' : 'No'}</h3>
                                            <table class='worker-status-table'>
                                                <tr>
                                                    <th>Name</th>
                                                    <th>Email</th>
                                                    <th>Job</th>
                                                    <th>Address</th>
                                                    <th>Phone Number</th>
                                                    <th>Company</th>
                                                    <th>Text</th>
                                                </tr>`;
                        status.request_history.forEach(function(request) {
                            tableContent += `<tr>
                                                <td>${request.name}</td>
                                                <td>${request.email}</td>
                                                <td>${request.job}</td>
                                                <td>${request.address}</td>
                                                <td>${request.phone_number}</td>
                                                <td>${request.company}</td>
                                                <td>${request.text}</td>
                                            </tr>`;
                        });
                        tableContent += '</table></div>';
                        content += tableContent;

                        $('#detailedWorkerStatusContainer').html(content);
                    }).fail(function() {
                        $('#detailedWorkerStatusContainer').append(`<div><p>Failed to load data for ${workerName}</p></div>`);
                    });
                });
            }

        });
    </script>
</head>
<body>
    <h1>Redis Pro Maxx</h1>

    <!-- Main Container for side-by-side layout -->
    <div class="main-container">
        <!-- Manage Worker Section -->
        <div class="manage-workers-section", style="position: relative;">
            <button id="refreshButton" style="position: absolute; top: 10px; right: 10px; border: none; background: none; font-size: 24px; cursor: pointer;">
                <i class="fas fa-sync-alt"></i>
            </button>
            <h2>Manage Workers</h2>
            <div class="button-select-pair">
                <button id="startButton">Create Workers</button>
                <select id="numWorkersSelect">
                    <option value="1">1 Worker</option>
                    <option value="2">2 Workers</option>
                    <option value="3">3 Workers</option>
                    <option value="4">4 Workers</option>
                    <option value="5">5 Workers</option>
                </select>            </div>

            <div class="button-select-pair">
                <button id="idleButton">Idle Time</button>
                <select id="idle_time_select">
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="30">30</option>
                    <option value="40">40</option>
                    <option value="50">50</option>
                </select>
            </div>

            <div class="button-select-pair">
                <button id="killButton">Kill Worker</button>
                <select id="workerSelect">  <!-- Changed ID -->
                    <!-- Options will be dynamically added here -->
                </select>
            </div>

            <p id="statusMessage">Ready to create or kill workers.</p>
            <!-- Task Metrics Container -->
            <div class="task-metrics-container">
                <div class="metric-box">
                    <h4>Active Workers:</h4>
                    <p id="activeWorkers">0</p>
                </div>
                <div class="metric-box">
                    <h4>Successful Tasks:</h4>
                    <p id="successfulTasks">0</p>
                </div>
                <div class="metric-box">
                    <h4>Total Tasks:</h4>
                    <p id="taskListDuplicates">0</p>
                </div>
            </div>
            <div id="activeWorkersList"></div>
        </div>

        <!-- Status and Send Data Section -->
        <div class="status-send-data-section">
            <!-- <button id="getStatusButton">Get Worker Status</button> -->
            <button id="sendFakeDataButton">Send Fake Data </button>
            <h2>Status and Send Data</h2>
            <div class="worker-status-container">
                <div id="workerStatus1" class="worker-status">No active worker</div>
                <div id="workerStatus2" class="worker-status">No active worker</div>
                <div id="workerStatus3" class="worker-status">No active worker</div>
                <div id="workerStatus4" class="worker-status">No active worker</div>
                <div id="workerStatus5" class="worker-status">No active worker</div>
            </div>


        </div>
    </div>
            <!-- Detailed Worker Status Container -->
    <div id="detailedWorkerStatusContainer">
        <h2>Detailed Worker Statuses</h2>
        <div id="allDetailedStatuses"></div>
    </div>
</body>

</html>
